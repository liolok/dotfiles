#!/bin/fish

echo "[1] Install packages for fish shell and nano editor"
cat (fallback $XDG_CONFIG_HOME ~/.config)/package-list/{fish, nano} \
    | sudo pacman --sync --refresh --sysupgrade --needed --asexplicit -

echo "[2] Cleanup bash dotfiles to user cache directory"
set bash_files ~/.bash*
if test -n "$bash_files"
    set bash_dir (fallback $XDG_CACHE_HOME ~/.cache)/bash_backup
    mkdir --parents $bash_dir
    for $file in $bash_files; mv --verbose $file $bash_dir; end
end

# (https://wiki.archlinux.org/title/OpenSSH#Force_public_key_authentication)
echo "[3] Turn off SSHD password authentication if user public key file exists"
if test -s ~/.ssh/authorized_keys # exists and size greater than zero
    sudo config --file=/etc/ssh/sshd_config 'PasswordAuthentication no'
end

echo "[4] Turn on Pacman misc options"
sudo config --file=/etc/pacman.conf Color VerbosePkgLists 'ParallelDownloads = 5'

echo "[5] Optimize network"
# (https://wiki.archlinux.org/title/Sysctl#Enable_TCP_Fast_Open)
# set --append params 'net.ipv4.tcp_fastopen = 3'
# (https://wiki.archlinux.org/title/Sysctl#Enable_BBR)
sudo modprobe tcp_bbr
set --append params 'net.core.default_qdisc = cake' 'net.ipv4.tcp_congestion_control = bbr'
sudo config --file=/etc/sysctl.d/01-network-optimization.conf $params
sudo sysctl --system

echo "[6] Set time zone and turn on NTP service"
sudo timedatectl set-timezone Asia/Shanghai
sudo timedatectl set-ntp true
